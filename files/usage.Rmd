---
title: "Utilization of Divvy Bikes "
author: Matthew Parin
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
current.year <- as.integer(format(Sys.Date(), "%Y"))
```

Install packages that are needed:

```{r, eval=FALSE}
# install.packages("lubridate")
# install.packages("data.table")
# install.packages("cowplot")
```

Load the package functions into your environment:

```{r, eval=TRUE}
library(data.table)
library(lubridate)
library(cowplot)
```

## Read the data into the environment

```{r, eval=FALSE}
stations <- as.data.frame(fread("~/DivvyChicago/data/Divvy_Stations_2017_Q1Q2.csv",
                                sep = ",", header = TRUE, stringsAsFactors = FALSE))
```

```{r, eval=FALSE}
rides <- as.data.frame(fread("~/DivvyChicago/data/Divvy_Trips_2016.csv",
                             sep = ",", header = TRUE, stringsAsFactors = FALSE))
```

## Clean the Station data

```{r, eval=FALSE}
rownames(stations) <- stations$name
stations$name      <- NULL
```

## Clean the Ride data using transform()

Create a function to use with transform()

```{r, eval=TRUE}
parse.dt <- function (x) {
  out    <- suppressWarnings(mdy_hms(x))
  i      <- is.na(out)
  out[i] <- mdy_hm(x[i])
  return(out)
}
```

```{r, eval=FALSE}
rides <- transform(rides, usertype = factor(usertype))
rides <- transform(rides, gender = factor(gender))
rides <- transform(rides, birthyear = as.numeric(birthyear))
rides <- transform(rides, current.age = as.numeric(current.year - birthyear))
rides <- transform(rides,
                   from_station_name = factor(from_station_name,
				                              rownames(stations)),
                   to_station_name   = factor(to_station_name,
				                              rownames(stations)))
rides <- transform(rides, starttime = parse.dt(starttime))
rides <- transform(rides, start.hour = as.numeric(format(starttime, "%H")))
rides <- transform(rides, start.week = as.numeric(format(starttime,"%W")))
rides <- transform(rides, start.week = factor(start.week))
rides <- transform(rides,
           start.day = factor(weekdays(as.Date(starttime)),
                              c("Monday","Tuesday","Wednesday","Thursday",
                                "Friday","Saturday","Sunday")))
rides <- transform(rides,
           start.month = factor(months(as.Date(starttime)),
                              c("January","February","March","April",
                                "May", "June", "July", "August",
                                "September","October","November",
                                "December")))
```

This code chunk parses the dates & times, then creates new tables columns for start.hour, start.week, start.day, and start.month.

## Add Counts of the data

Departure Counts

```{r}
count.departures <- table(rides$from_station_name)
all(names(count.departures) == rownames(stations))
```

Combine the departure counts with the stations data frame.

```{r}
count.departures <- as.vector(count.departures)
stations <- cbind(stations, count.departures)
```

## Define Counts by Specific Intervals

```{r, eval=FALSE}
count.departures.week <- table(rides$start.week)
count.departures.week <- as.vector(count.departures.week)
count.departures.week <- data.frame(week       = 0:52,
                          departures = count.departures.week)
```

```{r, eval=FALSE}
count.departures.hour <- table(rides$start.hour)
count.departures.hour <- as.vector(count.departures.hour)
count.departures.hour <- data.frame(hour       = 0:23,
                          departures = count.departures.hour)
```

Add Arrival Counts

```{r}
count.arrivals <- table(rides$to_station_name)
count.arrivals <- as.vector(count.arrivals)
count.arrivals <- data.frame(arrivals = count.arrivals)
stations <- cbind(stations, count.arrivals)
```


## Subset the data

Create weekday vs. weekend subsets

```{r}
rides.weekday <- subset(rides, rides$start.day == "Monday" |
                          rides$start.day == "Tuesday" |
                          rides$start.day == "Wednesday" |
                          rides$start.day == "Thursday" |
                          rides$start.day == "Friday")

rides.weekend <- subset(rides, rides$start.day == "Saturday" |
                          rides$start.day == "Sunday")
```

Create user segment subsets

```{r}
rides.subscribers <- subset(rides, rides$usertype == "Subscriber")
rides.customers <- subset(rides, rides$usertype == "Customer")
rides.dependent <- subset(rides, rides$usertype == "Dependent")
```

Create age segments

```{r}
age.labels <- c("Child", "College", "Young Professional", "30s", "40s", "50s", "60s", "70s", "80s", "90s", "100+")
age.categories <- cut(
  rides$current.age,
  breaks = c(0, 17, 22, 29, 39, 49, 59, 69, 79, 89, 99, 149),
  right = FALSE,
  labels = age.labels
)
table(age.categories)
```

It looks like some of the ages are not accurate. Many folks are not using their correct birth year.

```{r}
# TODO
# Build out a model to remove outliers from birth year.
```


